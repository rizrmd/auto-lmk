{{define "content"}}
<!-- Header Section -->
<div class="bg-white rounded-lg shadow mb-6">
    <div class="p-4 md:p-6 border-b border-gray-200">
        <div class="flex items-center justify-between mb-4">
            <a href="/admin/conversations" class="inline-flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                <span class="font-medium">Kembali ke List</span>
            </a>
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="flex-1">
                <span class="text-xl md:text-2xl font-bold text-gray-900" x-data x-text="formatPhone('{{.Conversation.PhoneNumber}}')"></span>
                <div class="flex items-center gap-3 mt-2">
                    {{if .Conversation.IsSales}}
                    <span class="inline-flex px-2.5 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                        Sales
                    </span>
                    {{else}}
                    <span class="inline-flex px-2.5 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                        Customer
                    </span>
                    {{end}}
                    <span class="text-sm text-gray-500">
                        Dibuat: {{.Conversation.CreatedAt}}
                    </span>
                </div>
            </div>
            <div class="mt-3 md:mt-0">
                <div class="text-sm text-gray-600">
                    Total Pesan: <span class="font-semibold text-gray-900">{{.TotalMessages}}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Message Thread Section -->
<div class="bg-white rounded-lg shadow">
    <div class="p-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900">Riwayat Percakapan</h2>
    </div>

    <!-- Message Thread -->
    <div id="message-thread" class="p-4 md:p-6 space-y-4 overflow-y-auto bg-gray-50" style="height: 600px; max-height: 70vh;">
        {{if .Messages}}

        <!-- Load Older Messages Button -->
        {{if gt .TotalMessages (len .Messages)}}
        <div class="text-center mb-4">
            <button hx-get="/admin/conversations/{{.Conversation.ID}}/messages?offset={{len .Messages}}&limit=50"
                    hx-target="#older-messages-container"
                    hx-swap="beforebegin"
                    hx-indicator="#loading-older-messages"
                    class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 shadow-sm transition-colors">
                Muat Pesan Lama
            </button>
            <div id="loading-older-messages" class="htmx-indicator hidden mt-2">
                <div class="inline-flex items-center">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-sm text-gray-600">Memuat pesan lama...</span>
                </div>
            </div>
        </div>
        <div id="older-messages-container"></div>
        {{end}}

        <!-- Messages -->
        {{range .Messages}}
        {{if eq .Direction "inbound"}}
        <!-- Inbound Message (Left-aligned) -->
        <div class="flex justify-start">
            <div class="bg-gray-100 rounded-lg p-3 max-w-md md:max-w-lg shadow-sm">
                <p class="text-sm text-gray-900 whitespace-pre-wrap break-words">{{.Content}}</p>
                <div class="mt-1 flex items-center gap-2">
                    <span class="text-xs text-gray-600 font-medium">{{.Sender}}</span>
                    <span class="text-xs text-gray-400">•</span>
                    <span class="text-xs text-gray-500">{{.CreatedAt}}</span>
                </div>
            </div>
        </div>
        {{else}}
        <!-- Outbound Message (Right-aligned) -->
        <div class="flex justify-end">
            <div class="bg-blue-100 rounded-lg p-3 max-w-md md:max-w-lg shadow-sm">
                <p class="text-sm text-gray-900 whitespace-pre-wrap break-words">{{.Content}}</p>
                <div class="mt-1 flex items-center gap-2 justify-end">
                    <span class="text-xs text-blue-700 font-semibold">BOT</span>
                    <span class="text-xs text-gray-400">•</span>
                    <span class="text-xs text-gray-600">{{.CreatedAt}}</span>
                </div>
            </div>
        </div>
        {{end}}
        {{end}}

        {{else}}
        <!-- Empty State -->
        <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Belum ada pesan</h3>
            <p class="mt-1 text-sm text-gray-500">Pesan akan muncul di sini saat ada percakapan</p>
        </div>
        {{end}}
    </div>
</div>

<script>
// Format phone number helper
function formatPhone(phone) {
    // Format: +62 812-3456-7890
    if (phone.startsWith('+62')) {
        const number = phone.substring(3);
        return '+62 ' + number.substring(0, 3) + '-' + number.substring(3, 7) + '-' + number.substring(7);
    }
    if (phone.startsWith('08')) {
        return '0' + phone.substring(1, 3) + '-' + phone.substring(3, 7) + '-' + phone.substring(7);
    }
    return phone;
}

// Auto-scroll to bottom on page load
window.addEventListener('DOMContentLoaded', function() {
    const thread = document.getElementById('message-thread');
    if (thread) {
        // Small delay to ensure all content is rendered
        setTimeout(function() {
            thread.scrollTop = thread.scrollHeight;
        }, 100);
    }
});

// Auto-scroll to maintain position after loading older messages
document.addEventListener('htmx:afterSwap', function(event) {
    const thread = document.getElementById('message-thread');
    const target = event.target;

    // Check if this is the messages container
    if (target && target.id === 'older-messages-container') {
        // Calculate the height of newly loaded content
        const newContent = target;
        if (newContent && newContent.children.length > 0) {
            // Get current scroll position
            const currentScroll = thread.scrollTop;
            const newContentHeight = newContent.offsetHeight;

            // Adjust scroll position to account for new content
            thread.scrollTop = currentScroll + newContentHeight + 20; // Add some padding
        }
    }
});

// Format date helper
function formatMessageDate(dateStr) {
    const date = new Date(dateStr);
    const day = date.getDate();
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
    const month = monthNames[date.getMonth()];
    const year = date.getFullYear();
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');

    return `${day} ${month} ${year}, ${hours}:${minutes}`;
}
</script>
{{end}}
